<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vocabulary 2C1</title>

<!-- PWA / Icons (cache-busting v=4) -->
<link rel="manifest" href="manifest.webmanifest?v=4">
<link rel="icon" href="icon-192.png?v=4" sizes="192x192">
<link rel="icon" href="icon-512.png?v=4" sizes="512x512">
<link rel="apple-touch-icon" href="icon-192.png?v=4">
<link rel="apple-touch-icon" sizes="180x180" href="icon-192.png?v=4">
<meta name="theme-color" content="#ffffff">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Vocabulary 2C1">

<!-- SheetJS para leer Excel en el navegador -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#0a0a0a;--muted:#667;--soft:#eef1ff;--primary:#2f6df6;--okbg:#e7f6ec;--ok:#1b5e20;--okb:#b6e2c0;--kobg:#ffeaea;--ko:#b71c1c;--kob:#f5b5b5;--border:#e6e8f0}
  @media (prefers-color-scheme: dark){
    :root{--bg:#0e1116;--card:#121622;--text:#eaeef7;--muted:#a0a8b8;--soft:#1e2a48;--primary:#6da4ff;--okbg:#16331d;--ok:#a9e6b6;--okb:#214d2a;--kobg:#3a1818;--ko:#ffb0b0;--kob:#5a2727;--border:#263047}
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);border:1px solid var(--border)}
  .header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border)}
  h1{margin:0;font-size:22px}
  .content{padding:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{display:flex;gap:8px;align-items:center}
  select,input[type="text"]{padding:12px 14px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:12px;font-size:16px}
  button{padding:12px 16px;border:none;border-radius:12px;font-size:16px;cursor:pointer}
  .primary{background:var(--primary);color:#fff}
  .ghost{background:var(--soft);color:var(--primary)}
  .danger{background:var(--kobg);color:var(--ko);border:1px solid var(--kob)}
  .muted{color:var(--muted)}
  .qbig{font-size:22px;font-weight:700;letter-spacing:.2px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .controls{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start}
  .stack{display:flex;flex-direction:column;gap:10px}
  .hidden{display:none}
  .panel{background:transparent;border:1px dashed var(--border);padding:16px;border-radius:12px}
  .banner{font-weight:700;padding:10px 14px;border-radius:10px}
  .banner.ok{background:var(--okbg);color:var(--ok);border:1px solid var(--okb)}
  .banner.ko{background:var(--kobg);color:var(--ko);border:1px solid var(--kob)}
  .info{font-size:14px;background:transparent;border:1px solid var(--border);border-radius:12px;padding:10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:999px;background:var(--soft);color:var(--primary);font-size:12px}
  .stats{display:flex;gap:18px;color:var(--text);font-size:14px;flex-wrap:wrap}
  .progress{height:10px;background:transparent;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:var(--primary)}
  .summary{background:transparent;border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px}
  .list{display:grid;grid-template-columns:1fr;gap:6px;max-height:260px;overflow:auto;padding:8px;border:1px dashed var(--border);border-radius:10px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--soft)}
  .subtools{width:100%;display:flex;justify-content:flex-end;gap:8px;margin-top:6px}
  button.tiny{font-size:12px;padding:6px 10px}
  .welcome .content{display:grid;gap:14px}
  .welcome h2{margin:0;font-size:20px}
  .divider{height:1px;background:var(--border);margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="appCard">

    <!-- CABECERA -->
    <div class="header">
      <h1>Vocabulary 2C1</h1>
      <div class="row">
        <button class="ghost" id="btnReset">Reiniciar</button>
        <div class="subtools">
          <button class="tiny" id="btnExport">Exportar progreso</button>
          <button class="tiny" id="btnImport">Importar progreso</button>
          <input type="file" id="fileImport" accept="application/json" class="hidden">
        </div>
      </div>
    </div>

    <!-- BIENVENIDA / CONFIG -->
    <div class="content welcome" id="welcomeView">
      <h2>Configura el modo de preguntas</h2>
      <div class="row">
        <label>Modo:
          <select id="w_mode">
            <option value="es_en">Español → Inglés</option>
            <option value="en_es">Inglés → Español</option>
          </select>
        </label>
        <label>Orden:
          <select id="w_order">
            <option value="random">Aleatorio</option>
            <option value="sequential">Secuencial</option>
          </select>
        </label>
        <label>Tema:
          <select id="w_topic"></select>
        </label>
        <label>Tipo:
          <select id="w_runMode">
            <option value="reiniciar">Reiniciar</option>
            <option value="completar">Completar</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="w_exam"> Modo examen (no mostrar soluciones hasta el final)</label>
      </div>
      <div class="divider"></div>
      <div id="resumeBox" class="row hidden">
        <span class="muted" id="resumeText">Se encontró progreso anterior.</span>
        <button class="ghost" id="btnResume">Continuar donde lo dejé</button>
      </div>
      <div class="row">
        <button class="primary" id="btnStart">Continuar</button>
      </div>
      <div id="bannerWelcome" class="banner hidden"></div>
    </div>

    <!-- VISTA QUIZ -->
    <div class="content hidden" id="quizView">
      <div id="banner" class="banner hidden"></div>

      <div class="grid panel">
        <div class="qbig"><span class="muted">Traduce:</span> <span id="prompt"></span></div>
        <input id="answer" type="text" placeholder="Escribe tu respuesta y pulsa Enter">

        <div class="controls">
          <div class="stack">
            <button class="primary" id="btnCheck">Comprobar (Enter)</button>
            <button class="ghost hidden" id="btnNext">Siguiente (Enter)</button>
          </div>
          <button id="btnReveal">Mostrar solución</button>
          <button class="ghost" id="btnSkip">Saltar</button>
          <button class="danger" id="btnHard">Marcar como difícil</button>
        </div>

        <div class="progress"><div class="bar" id="progressBar"></div></div>
        <div class="stats" id="stats"></div>

        <div id="feedback"></div>
        <div class="info" id="extraInfo"></div>

        <div class="chips" id="chips"></div>

        <div id="summary" class="summary hidden">
          <h3>Resumen</h3>
          <div id="sumCounts" class="stats"></div>
          <div class="row">
            <div style="flex:1">
              <strong>Acertadas</strong>
              <div id="sumRight" class="list"></div>
            </div>
            <div style="flex:1">
              <strong>Falladas</strong>
              <div id="sumWrong" class="list"></div>
            </div>
          </div>
          <div style="margin-top:10px">
            <button class="primary" id="sumRestart">Volver a empezar</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ================== CARGA DE EXCEL Y PREPARACIÓN DE DATA ================== */
let DATA = [];
const FLEX_VARIANTS = {
  "dedo de la mano": ["dedo de la mano","dedo mano"],
  "dedos del pie": ["dedos del pie","dedos pie"],
  "uñas de los pies": ["uñas de los pies","uñas pies","uñas de los pie"]
};

async function loadExcelToDATA() {
  // Descarga el Excel desde la raíz del repo
  const res = await fetch('Vocabulary.xlsx', { cache: 'no-store' });
  if (!res.ok) throw new Error('No se pudo descargar Vocabulary.xlsx');
  const buf = await res.arrayBuffer();

  // Lee con SheetJS
  const wb = XLSX.read(buf, { type: 'array' });
  const wsName = wb.SheetNames[0];
  const ws = wb.Sheets[wsName];

  // Convierte a JSON de filas
  const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: "" });
  if (!rows.length) throw new Error('El Excel está vacío');

  // Cabeceras y búsqueda de columnas
  const header = rows[0].map(h => String(h || '').trim());
  function findCol(candidates, fallbackIndex) {
    for (const cand of candidates) {
      const idx = header.findIndex(h => h.toLowerCase() === cand.toLowerCase());
      if (idx >= 0) return idx;
    }
    return Math.min(fallbackIndex, header.length - 1);
  }

  const idxA = findCol(["English","Inglés","Ingles","EN","Word"], 0);
  const idxB = findCol(["Part of speech","B","POS"], 1);
  const idxC = findCol(["Pronunciation","C","IPA"], 2);
  const idxD = findCol(["Example sentence","D","Sentence","Ejemplo"], 3);
  const idxE = findCol(["Castellano","Español","Spanish","ES","Traducción"], 4);
  const idxF = findCol(["File","Tema","Topic","Unidad"], 5);

  // Construye DATA
  const out = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i] || [];
    const en = String(r[idxA] || '').trim();
    const es = String(r[idxE] || '').trim();
    if (!en || !es) continue;
    out.push({
      id: i-1,
      english: en,
      spanish: es,
      b: String(r[idxB] || '').trim(),
      c: String(r[idxC] || '').trim(),
      d: String(r[idxD] || '').trim(),
      topic: String(r[idxF] || '').trim()
    });
  }
  DATA = out;
}

/* ================== LÓGICA DE LA APP ================== */
function stripDiacritics(s){return s.normalize('NFD').replace(/\p{Diacritic}+/gu,'').replace(/ñ/g,'n').replace(/Ñ/g,'N')}
function norm(s){return stripDiacritics(String(s||'').trim().toLowerCase()).replace(/\s+/g,' ')}
function softNorm(s){return String(s||'').trim().toLowerCase().replace(/\s+/g,' ')}
function buildAcceptableSet(spanish){const base=norm(spanish);const set=new Set([base]);const v=FLEX_VARIANTS[spanish?.toLowerCase()];if(v){for(const x of v)set.add(norm(x));}return set}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function keyFor(topic,mode,runMode,exam){return `vocab2c1::${topic}::${mode}::${runMode}::${exam?'exam':'normal'}`}

let TOPICS = [];
const state={items:[], filtered:[], order:'random', mode:'es_en', runMode:'reiniciar', topic:'Todos', exam:false, queue:[], idx:0, seen:0, correct:0, hard:new Set(), phase:'answer', failedThisRound:new Set(), rightAll:new Set(), wrongAll:new Set()};

function saveProgress(){const k=keyFor(state.topic,state.mode,state.runMode,state.exam); const queueIds=state.queue.map(i=>state.filtered[i]?.id).filter(v=>v!==undefined); const payload={version:2, filteredIds:state.filtered.map(it=>it.id), queueIds, idx:state.idx, seen:state.seen, correct:state.correct, failedThisRound:[...state.failedThisRound], rightAll:[...state.rightAll], wrongAll:[...state.wrongAll], hard:[...state.hard], order:state.order, phase:state.phase}; try{localStorage.setItem(k,JSON.stringify(payload))}catch(e){}}
function loadProgress(){const k=keyFor(state.topic,state.mode,state.runMode,state.exam); let raw=null; try{raw=localStorage.getItem(k)}catch(e){raw=null} if(!raw)return false; let data=null; try{data=JSON.parse(raw)}catch(e){return false} const curr=new Set(state.filtered.map(it=>it.id)); const saved=new Set((data.filteredIds||[])); if(curr.size!==saved.size)return false; for(const id of curr){if(!saved.has(id))return false} const idToIdx=new Map(state.filtered.map((it,i)=>[it.id,i])); const rebuilt=(data.queueIds||[]).map(id=>idToIdx.get(id)).filter(i=>i!==undefined); if(!rebuilt.length)return false; state.queue=rebuilt; state.idx=Math.min(Math.max(0,data.idx||0),state.queue.length-1); state.seen=data.seen||0; state.correct=data.correct||0; state.failedThisRound=new Set(data.failedThisRound||[]); state.rightAll=new Set(data.rightAll||[]); state.wrongAll=new Set(data.wrongAll||[]); state.hard=new Set(data.hard||[]); state.order=data.order||state.order; state.phase='answer'; return true;}
function clearProgress(){const k=keyFor(state.topic,state.mode,state.runMode,state.exam); try{localStorage.removeItem(k)}catch(e){}}

function setBanner(id,text,ok){const el=document.getElementById(id); el.textContent=text; el.classList.remove('hidden','ok','ko'); el.classList.add(ok?'ok':'ko')}
function clearBanner(id){const el=document.getElementById(id); el.textContent=''; el.classList.add('hidden'); el.classList.remove('ok','ko')}

function applyFilter(){state.filtered=state.items.filter(x=>state.topic==='Todos'?true:(x.topic===state.topic))}
function buildQueue(){const idxs=state.filtered.map((_,i)=>i); state.queue=(state.order==='random')?shuffle(idxs):idxs; state.idx=0}
function currentItem(){const i=state.queue[state.idx]??0; return state.filtered[i]}
function percent(){if(!state.queue.length)return 0; return Math.round(((state.idx)/state.queue.length)*100)}
function updateProgressUI(){document.getElementById('progressBar').style.width=percent()+'%'; document.getElementById('stats').textContent=`Aciertos: ${state.correct} · Intentos: ${state.seen} · Tema: ${state.topic} · ${state.idx+1}/${state.queue.length}`}
function renderExtraInfo(it){const parts=[]; if(it.d) parts.push(`<div><b>Example sentence:</b> ${it.d}</div>`); if(it.c) parts.push(`<div><b>C:</b> ${it.c}</div>`); if(it.b) parts.push(`<div><b>B:</b> ${it.b}</div>`); return parts.join('')||'<div class="muted">Sin información adicional.</div>'}
function toggleReviewUI(on){document.getElementById('btnNext').classList.toggle('hidden',!on); ['btnCheck','btnReveal','btnSkip','btnHard','answer'].forEach(id=>{const el=document.getElementById(id); if(el) el.disabled=on})}
function clearExtraAndFeedback(){document.getElementById('extraInfo').innerHTML=''; document.getElementById('feedback').innerHTML=''; toggleReviewUI(false); clearBanner('banner')}
function updateUI(reset=false){const it=currentItem(); if(!it){document.getElementById('prompt').textContent='(Sin datos)'; return} document.getElementById('prompt').textContent=(state.mode==='es_en')?it.spanish:it.english; if(reset) document.getElementById('answer').value=''; document.getElementById('chips').innerHTML=''; clearExtraAndFeedback(); updateProgressUI(); document.getElementById('answer').focus()}

function gotoNext(){state.idx++; if(state.idx>=state.queue.length){handleEndOfCycle(); return} state.phase='answer'; updateUI(true); saveProgress()}
function handleEndOfCycle(){if(state.runMode==='reiniciar'){const failed=[...state.failedThisRound]; state.failedThisRound.clear(); if(failed.length>0){const map=new Map(state.filtered.map((it,idx)=>[it.id,idx])); const nextIdxs=failed.map(id=>map.get(id)).filter(i=>i!==undefined); state.queue=(state.order==='random')?shuffle(nextIdxs):nextIdxs; state.idx=0; state.phase='answer'; updateUI(true); saveProgress(); return}} showSummary(); saveProgress()}
function showSummary(){state.phase='summary'; document.getElementById('btnNext').classList.add('hidden'); ['btnCheck','btnReveal','btnSkip','btnHard','answer'].forEach(id=>{const el=document.getElementById(id); if(el) el.disabled=true}); const sum=document.getElementById('summary'); const sumCounts=document.getElementById('sumCounts'); const sumRight=document.getElementById('sumRight'); const sumWrong=document.getElementById('sumWrong'); const right=[...state.rightAll], wrong=[...state.wrongAll]; const map=new Map(state.items.map(it=>[it.id,it])); sumCounts.textContent=`Aciertos: ${state.correct} · Intentos: ${state.seen} · Tema: ${state.topic} · Palabras: ${state.filtered.length}`; function render(ids){return ids.map(id=>{const it=map.get(id); if(!it) return ''; const shown=(state.mode==='es_en')?`${it.spanish} → ${it.english}`:`${it.english} → ${it.spanish}`; return `<div><span class='pill'>${shown}</span></div>`}).join('')} sumRight.innerHTML=render(right); sumWrong.innerHTML=render(wrong); sum.classList.remove('hidden')}

function showSolutionAndInfo(it, solutionText, note=''){const fb=document.getElementById('feedback'); const ex=document.getElementById('extraInfo'); const noteHtml=note?` <span class='muted'>(${note})</span>`:''; fb.innerHTML='Solución: <b>'+solutionText+'</b>'+noteHtml; ex.innerHTML=renderExtraInfo(it); state.phase='review'; toggleReviewUI(true); saveProgress()}
function check(){if(state.phase!=='answer') return; const it=currentItem(); if(!it) return; let userRaw=String(document.getElementById('answer').value||''); userRaw=userRaw.trimEnd(); const userSoft=softNorm(userRaw), userHard=norm(userRaw); let ok=false, solution='', accentsIgnored=false; if(state.mode==='es_en'){solution=it.english; ok=(userSoft===softNorm(it.english))} else {solution=it.spanish; const acceptable=buildAcceptableSet(it.spanish); if(acceptable.has(userHard)){ok=true; if(!acceptable.has(userSoft)) accentsIgnored=true}} state.seen++; if(ok){state.correct++; state.rightAll.add(it.id); state.wrongAll.delete(it.id); setBanner('banner','Acierto. ¡Muy bien!',true)} else {state.failedThisRound.add(it.id); state.wrongAll.add(it.id); state.rightAll.delete(it.id); setBanner('banner','Fallo. ¡Revisa tu respuesta!',false)} const note=(accentsIgnored && state.mode==='en_es')?'Se han ignorado los acentos en español':''; showSolutionAndInfo(it,solution,note)}
function reveal(){if(state.phase!=='answer') return; const it=currentItem(); if(!it) return; const sol=(state.mode==='es_en')?it.english:it.spanish; setBanner('banner','Mostrada la solución de esta tarjeta.',false); showSolutionAndInfo(it,sol)}
function skip(){if(state.phase!=='answer') return; const it=currentItem(); if(!it) return; const sol=(state.mode==='es_en')?it.english:it.spanish; setBanner('banner','Mostrada la solución de esta tarjeta.',false); showSolutionAndInfo(it,sol)}
function markHard(){if(state.phase!=='answer') return; const it=currentItem(); if(!it) return; const from=(state.mode==='es_en')?it.spanish:it.english; const key=from.toLowerCase(); if(state.hard.has(key)) state.hard.delete(key); else state.hard.add(key); const sol=(state.mode==='es_en')?it.english:it.spanish; setBanner('banner','Marcada como difícil. Revisa y continúa cuando quieras.',false); showSolutionAndInfo(it,sol)}

document.getElementById('btnCheck').addEventListener('click',check);
document.getElementById('btnReveal').addEventListener('click',reveal);
document.getElementById('btnSkip').addEventListener('click',skip);
document.getElementById('btnHard').addEventListener('click',markHard);
document.getElementById('btnNext').addEventListener('click',gotoNext);
document.getElementById('sumRestart').addEventListener('click',()=>{ goWelcome(true) });

document.getElementById('btnExport').addEventListener('click',exportAllProgress);
document.getElementById('btnImport').addEventListener('click',()=>document.getElementById('fileImport').click());
document.getElementById('fileImport').addEventListener('change',e=>{const f=e.target.files&&e.target.files[0]; if(f) importAllProgressFromFile(f); e.target.value=''});

document.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ if(viewIsQuiz() && state.phase==='answer') check(); else if(viewIsQuiz() && state.phase==='review') gotoNext(); }});
document.getElementById('btnReset').addEventListener('click',()=>goWelcome(false));

function exportAllProgress(){const prefix='vocab2c1::'; const dump={}; for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i); if(k&&k.startsWith(prefix)) dump[k]=localStorage.getItem(k)} const blob=new Blob([JSON.stringify(dump,null,2)],{type:'application/json'}); const a=document.createElement('a'); const date=new Date().toISOString().slice(0,10); a.href=URL.createObjectURL(blob); a.download=`vocabulary_2c1_progreso_${date}.json`; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()},0); setBanner('banner','Progreso exportado a JSON.',true)}
function importAllProgressFromFile(file){const reader=new FileReader(); reader.onload=e=>{try{const obj=JSON.parse(String(e.target.result||'{}')); const prefix='vocab2c1::'; let count=0; for(const [k,v] of Object.entries(obj)){ if(String(k).startsWith(prefix)&&typeof v==='string'){ try{localStorage.setItem(k,v); count++}catch(e){} }} setBanner('bannerWelcome',`Importación completada (${count} claves).`,true); document.getElementById('resumeBox').classList.remove('hidden')}catch(err){ setBanner('bannerWelcome','Archivo inválido. Selecciona el JSON exportado.',false) }}; reader.readAsText(file)}

function viewIsQuiz(){ return !document.getElementById('quizView').classList.contains('hidden') }
function goWelcome(hard){ if(hard){clearProgress()} document.getElementById('welcomeView').classList.remove('hidden'); document.getElementById('quizView').classList.add('hidden'); configureTopics('w_topic'); const hasSaved=Object.keys(localStorage).some(k=>k.startsWith('vocab2c1::')); document.getElementById('resumeBox').classList.toggle('hidden', !hasSaved); clearBanner('banner'); clearBanner('bannerWelcome') }
function startFromWelcome(resume){ state.mode=document.getElementById('w_mode').value; state.order=document.getElementById('w_order').value; state.topic=document.getElementById('w_topic').value||'Todos'; state.runMode=document.getElementById('w_runMode').value; state.exam=document.getElementById('w_exam').checked; applyFilter(); buildQueue(); let loaded=false; if(resume){loaded=loadProgress()} if(!loaded){state.idx=0; state.seen=0; state.correct=0; state.failedThisRound.clear(); state.rightAll.clear(); state.wrongAll.clear()} document.getElementById('welcomeView').classList.add('hidden'); document.getElementById('quizView').classList.remove('hidden'); document.getElementById('btnReveal').classList.toggle('hidden', state.exam); document.getElementById('btnSkip').classList.toggle('hidden', state.exam); document.getElementById('btnHard').classList.toggle('hidden', state.exam); state.phase='answer'; updateUI(true); saveProgress() }

function configureTopics(selId){
  TOPICS = ['Todos', ...Array.from(new Set((DATA||[]).map(x=>x.topic||'').filter(x=>x && x.trim()!=='')))];
  const sel=document.getElementById(selId);
  sel.innerHTML = TOPICS.map(t=>`<option value="${t}">${t}</option>`).join('');
}

/* ============== INICIO ============== */
(async function init(){
  // 1) Cargar Excel -> DATA
  try{
    await loadExcelToDATA();
  }catch(err){
    console.error(err);
    setBanner('bannerWelcome','No se pudo cargar Vocabulary.xlsx. Asegúrate de subirlo a la raíz del repo.', false);
  }
  state.items = (DATA || []).slice();

  // 2) Preparar bienvenida
  configureTopics('w_topic');
  document.getElementById('btnStart').addEventListener('click', ()=>startFromWelcome(false));
  document.getElementById('btnResume').addEventListener('click', ()=>startFromWelcome(true));

  // Si hay progreso previo, preselecciona con heurística básica (toma primer perfil guardado)
  let lastKey=null;
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k && k.startsWith('vocab2c1::')){ lastKey=k; break; }
  }
  if(lastKey){
    const parts=lastKey.split('::'); // vocab2c1::topic::mode::runMode::(exam|normal)
    if(parts.length>=5){
      const [_p,topic,mode,run,examTag]=parts;
      if(TOPICS.includes(topic)) document.getElementById('w_topic').value=topic;
      if(['es_en','en_es'].includes(mode)) document.getElementById('w_mode').value=mode;
      if(['reiniciar','completar'].includes(run)) document.getElementById('w_runMode').value=run;
      document.getElementById('w_exam').checked = (examTag==='exam');
      document.getElementById('resumeBox').classList.remove('hidden');
    }
  }

  // 3) Mostrar vista bienvenida
  goWelcome(false);
})();
</script>
</body>
</html>
