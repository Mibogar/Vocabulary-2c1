<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vocabulary 2C1</title>

<!-- PWA / Icons -->
<link rel="manifest" href="manifest.webmanifest?v=8">
<link rel="icon" href="icon-192.png?v=8" sizes="192x192">
<link rel="icon" href="icon-512.png?v=8" sizes="512x512">
<link rel="apple-touch-icon" href="icon-192.png?v=8">
<link rel="apple-touch-icon" sizes="180x180" href="icon-192.png?v=8">
<meta name="theme-color" content="#ffffff">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Vocabulary 2C1">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#0a0a0a; --muted:#9aa3b2;
    --soft:#eef1ff; --primary:#2f6df6;
    --okbg:#e7f6ec; --ok:#1b5e20; --okb:#b6e2c0;
    --kobg:#ffeaea; --ko:#b71c1c; --kob:#f5b5b5;
    --border:#e6e8f0
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0e1116; --card:#121622; --text:#eaeef7; --muted:#92a0b6;
      --soft:#1e2a48; --primary:#6da4ff;
      --okbg:#16331d; --ok:#a9e6b6; --okb:#214d2a;
      --kobg:#3a1818; --ko:#ffb0b0; --kob:#5a2727;
      --border:#263047
    }
  }
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
  }
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  .card{
    background:var(--card);
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
    border:1px solid var(--border)
  }
  .header{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:16px 18px;
    border-bottom:1px solid var(--border)
  }
  h1{margin:0;font-size:22px}
  .content{padding:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{display:flex;gap:8px;align-items:center}
  select,input[type="text"]{
    padding:12px 14px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--text);
    border-radius:12px;
    font-size:16px
  }
  button{
    padding:12px 16px;
    border:none;
    border-radius:12px;
    font-size:16px;
    cursor:pointer
  }
  .primary{background:var(--primary);color:#fff}
  .ghost{background:var(--soft);color:var(--primary)}
  .danger{
    background:var(--kobg);
    color:var(--ko);
    border:1px solid var(--kob)
  }
  .muted{color:var(--muted)}
  .qbig{font-size:22px;font-weight:700;letter-spacing:.2px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .controls{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start}
  .stack{display:flex;flex-direction:column;gap:10px}
  .hidden{display:none}
  .panel{
    background:transparent;
    border:1px dashed var(--border);
    padding:16px;
    border-radius:12px
  }
  .banner{
    font-weight:700;
    padding:10px 14px;
    border-radius:10px
  }
  .banner.ok{
    background:var(--okbg);
    color:var(--ok);
    border:1px solid var(--okb)
  }
  .banner.ko{
    background:var(--kobg);
    color:var(--ko);
    border:1px solid var(--kob)
  }
  .info{
    font-size:14px;
    background:transparent;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px
  }
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    padding:6px 10px;
    border-radius:999px;
    background:var(--soft);
    color:var(--primary);
    font-size:12px
  }
  .stats{
    display:flex;
    gap:18px;
    color:var(--text);
    font-size:14px;
    flex-wrap:wrap
  }
  .progress{
    height:10px;
    background:transparent;
    border:1px solid var(--border);
    border-radius:999px;
    overflow:hidden
  }
  .bar{
    height:100%;
    width:0;
    background:var(--primary)
  }
  .summary{
    background:transparent;
    border:1px solid var(--border);
    border-radius:12px;
    padding:16px;
    margin-top:14px
  }
  .list{
    display:grid;
    grid-template-columns:1fr;
    gap:6px;
    max-height:260px;
    overflow:auto;
    padding:8px;
    border:1px dashed var(--border);
    border-radius:10px
  }
  .pill{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    background:var(--soft)
  }
  .welcome .content{display:grid;gap:14px}
  .welcome h2{margin:0;font-size:20px}
  .divider{height:1px;background:var(--border);margin:8px 0}

  /* extra panels */
  .smallNote{font-size:14px;color:var(--muted)}
  .hardListBox{
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    max-height:240px;
    overflow:auto;
    font-size:15px;
    line-height:1.4
  }
  .flexBetween{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="appCard">

    <!-- CABECERA -->
    <div class="header">
      <h1>Vocabulary 2C1</h1>
      <div class="row">
        <button class="ghost" id="btnReset">Reiniciar</button>
      </div>
    </div>

    <!-- BIENVENIDA / CONFIG -->
    <div class="content welcome" id="welcomeView">
      <h2>Configura el modo de preguntas</h2>

      <div class="row">
        <label>Modo:
          <select id="w_mode">
            <option value="es_en">Espa√±ol ‚Üí Ingl√©s</option>
            <option value="en_es">Ingl√©s ‚Üí Espa√±ol</option>
          </select>
        </label>

        <label>Orden:
          <select id="w_order">
            <option value="random">Aleatorio</option>
            <option value="sequential">Secuencial</option>
          </select>
        </label>

        <label>Tema:
          <select id="w_topic"></select>
        </label>

        <label>Tipo:
          <select id="w_runMode">
            <option value="reiniciar">Reiniciar</option>
            <option value="completar">Completar</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label><input type="checkbox" id="w_exam"> Modo examen (no mostrar soluciones hasta el final)</label>
      </div>

      <div class="divider"></div>

      <!-- progreso reciente -->
      <div class="row flexBetween">
        <div class="smallNote" id="lastResultBox">√öltimo resultado: --</div>
        <button class="ghost" id="btnHardest">Ver palabras que m√°s me cuestan</button>
      </div>

      <div class="divider"></div>

      <div id="resumeBox" class="row hidden">
        <span class="muted" id="resumeText">Se encontr√≥ progreso anterior.</span>
        <button class="ghost" id="btnResume">Continuar donde lo dej√©</button>
      </div>

      <div class="row">
        <button class="primary" id="btnStart">Continuar</button>
      </div>

      <div id="bannerWelcome" class="banner hidden"></div>
    </div>

    <!-- VISTA TOP PALABRAS QUE ME CUESTAN -->
    <div class="content hidden" id="hardestView">
      <div class="row flexBetween">
        <h2 style="margin:0;font-size:20px">Palabras que m√°s me cuestan</h2>
        <button class="ghost" id="btnBackToWelcome">Volver</button>
      </div>

      <div class="smallNote">
        Estas son las palabras con m√°s fallos (equivocarse, pedir soluci√≥n o saltar). M√°x 10.
      </div>

      <div class="hardListBox" id="hardListBox">
        <!-- se rellena din√°micamente -->
      </div>

      <div class="row" style="margin-top:12px">
        <button class="primary" id="btnPracticeHardest">Practicar solo estas ahora</button>
      </div>
    </div>

    <!-- VISTA QUIZ -->
    <div class="content hidden" id="quizView">
      <div id="banner" class="banner hidden"></div>

      <div class="grid panel">
        <div class="qbig"><span class="muted">Traduce:</span> <span id="prompt"></span></div>
        <input id="answer" type="text" placeholder="Escribe tu respuesta y pulsa Enter">

        <div class="controls">
          <div class="stack">
            <button class="primary" id="btnCheck">Comprobar (Enter)</button>
            <button class="ghost hidden" id="btnNext">Siguiente (Enter)</button>
          </div>
          <button id="btnReveal">Mostrar soluci√≥n</button>
          <button class="ghost" id="btnSkip">Saltar</button>
          <button class="danger" id="btnHard">Marcar como dif√≠cil</button>
          <button class="ghost hidden" id="btnUnhard">Ya no es dif√≠cil</button>
        </div>

        <div class="progress"><div class="bar" id="progressBar"></div></div>
        <div class="stats" id="stats"></div>

        <div id="feedback"></div>
        <div class="info" id="extraInfo"></div>

        <div class="chips" id="chips"></div>

        <div id="summary" class="summary hidden">
          <h3>Resumen</h3>
          <div id="sumCounts" class="stats"></div>

          <div class="row">
            <div style="flex:1">
              <strong>Acertadas</strong>
              <div id="sumRight" class="list"></div>
            </div>
            <div style="flex:1">
              <strong>Falladas</strong>
              <div id="sumWrong" class="list"></div>
            </div>
          </div>

          <!-- Bloque de progreso / evoluci√≥n -->
          <div class="info" style="margin-top:14px;font-size:14px" id="progressBox">
            <strong>üìà Tu progreso</strong><br>
            <span id="progressPrev">Sesi√≥n anterior: --</span><br>
            <span id="progressNow">Hoy: --</span>
          </div>

          <div style="margin-top:10px">
            <button class="primary" id="sumRestart">Volver a empezar</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ================== CARGA DE EXCEL ================== */
let DATA = [];
const FLEX_VARIANTS = {
  "dedo de la mano": ["dedo de la mano","dedo mano"],
  "dedos del pie": ["dedos del pie","dedos pie"],
  "u√±as de los pies": ["u√±as de los pies","u√±as pies","u√±as de los pie"]
};
function parseList(s){
  if(!s) return [];
  return String(s).split(/[,;/]/).map(x=>x.trim()).filter(Boolean);
}
async function loadExcelToDATA() {
  const url = 'Vocabulary con sin√≥nimos y acepciones.xlsx';
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('No se pudo descargar el Excel: ' + url);
  const buf = await res.arrayBuffer();

  const wb = XLSX.read(buf, { type: 'array' });
  const wsName = wb.SheetNames[0];
  const ws = wb.Sheets[wsName];

  const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: "" });
  if (!rows.length) throw new Error('El Excel est√° vac√≠o');

  const header = rows[0].map(h => String(h || '').trim());
  function idx(exact){ return header.findIndex(h => h.toLowerCase() === exact.toLowerCase()); }
  function val(r,i){ return (r && i>=0 && i<r.length) ? String(r[i]||'').trim() : ''; }

  const iA = idx('English');
  const iB = idx('Sin√≥nimos / expresiones equivalentes (English)');
  const iC = idx('Acepciones adicionales (English)');
  const iD = idx('Castellano');
  const iE = idx('Sin√≥nimos o expresiones equivalentes (en espa√±ol)');
  const iF = idx('Acepciones adicionales (en espa√±ol)');
  const iG = idx('Part of speech');
  const iH = idx('Pronunciation');
  const iI = idx('Example sentence');
  const iJ = idx('File');
  const iK = idx('Section');

  const out = [];
  for (let r=1;r<rows.length;r++){
    const row = rows[r] || [];
    const en = val(row, iA);
    const es = val(row, iD);
    if(!en || !es) continue;
    out.push({
      id: r-1,
      english: en,
      spanish: es,
      en_syn: val(row, iB),
      en_mean: val(row, iC),
      es_syn: val(row, iE),
      es_mean: val(row, iF),
      pos: val(row, iG),
      pron: val(row, iH),
      example: val(row, iI),
      topic: val(row, iJ),     // tema grande
      section: val(row, iK),   // subtema
      en_syn_list: parseList(val(row, iB)),
      es_syn_list: parseList(val(row, iE))
    });
  }
  DATA = out;
}
</script>

<script>
/*** ================== ESTADO & UTILIDADES ================== ***/
function stripDiacritics(s){
  return s
    .normalize('NFD')
    .replace(/\p{Diacritic}+/gu,'')
    .replace(/√±/g,'n')
    .replace(/√ë/g,'N');
}
function norm(s){
  return stripDiacritics(String(s||'').trim().toLowerCase()).replace(/\s+/g,' ');
}
function softNorm(s){
  return String(s||'').trim().toLowerCase().replace(/\s+/g,' ');
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function todayStr(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

function keyForSession(topic,mode,runMode,exam){
  return `vocab2c1::${topic}::${mode}::${runMode}::${exam?'exam':'normal'}`;
}
const FAIL_KEY = 'vocab2c1::failStats';   // registro de fallos
const HIST_KEY = 'vocab2c1::history';     // historial de % acierto por d√≠a
const HARD_KEY = 'vocab2c1::hardSet';     // palabras marcadas como dif√≠ciles (global)

function loadJSON(key, fallback){
  try{
    const raw=localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){
    return fallback;
  }
}
function saveJSON(key,obj){
  try{
    localStorage.setItem(key,JSON.stringify(obj));
  }catch(e){}
}

/*** ================== GESTI√ìN "DIF√çCILES" GLOBAL ================== ***/
// Vamos a guardar las dif√≠ciles como claves "english|spanish" en un Set persistente
function hardKeyFor(it){
  return `${it.english}|${it.spanish}`.toLowerCase();
}
function loadHardSet(){
  const arr = loadJSON(HARD_KEY,[]);
  return new Set(arr);
}
function saveHardSet(set){
  saveJSON(HARD_KEY,[...set]);
}

/*** ================== REGISTRO DE FALLOS ================== ***/
// fallos["finger|dedo de la mano"] = 7
function regFail(it){
  const failObj = loadJSON(FAIL_KEY,{});
  const k = hardKeyFor(it);
  failObj[k] = (failObj[k]||0)+1;
  saveJSON(FAIL_KEY,failObj);
}
function topFailList(limit=10){
  const failObj = loadJSON(FAIL_KEY,{});
  // convertimos a array [key,count] y ordenamos desc
  const arr = Object.entries(failObj).sort((a,b)=>b[1]-a[1]);
  return arr.slice(0,limit);
}

/*** ================== HISTORIAL DE PROGRESO ================== ***/
function regSessionResult(pct){
  // pct: porcentaje acierto actual
  const hist = loadJSON(HIST_KEY,[]);
  hist.push({date: todayStr(), pct});
  saveJSON(HIST_KEY,hist);
}
function lastTwoResults(){
  const hist = loadJSON(HIST_KEY,[]);
  if(hist.length===0) return {prev:null,now:null};
  if(hist.length===1) return {prev:null,now:hist[0]};
  return {prev:hist[hist.length-2], now:hist[hist.length-1]};
}
function lastResult(){
  const hist = loadJSON(HIST_KEY,[]);
  if(hist.length===0) return null;
  return hist[hist.length-1];
}

/*** ================== L√ìGICA PRINCIPAL DE ESTUDIO ================== ***/
let TOPICS = [];
const state={
  items:[],
  filtered:[],
  order:'random',
  mode:'es_en',
  runMode:'reiniciar',
  topic:'Todos',
  exam:false,
  queue:[],
  idx:0,
  seen:0,
  correct:0,
  phase:'answer', // 'answer' | 'review' | 'summary'
  failedThisRound:new Set(),
  rightAll:new Set(),
  wrongAll:new Set(),
  usingHardestList:false, // true si venimos de "Practicar solo estas ahora"
  hardSet:new Set()
};

function saveProgress(){
  const k=keyForSession(state.topic,state.mode,state.runMode,state.exam);
  const queueIds=state.queue.map(i=>state.filtered[i]?.id).filter(v=>v!==undefined);
  const payload={
    version:5,
    filteredIds:state.filtered.map(it=>it.id),
    queueIds,
    idx:state.idx,
    seen:state.seen,
    correct:state.correct,
    failedThisRound:[...state.failedThisRound],
    rightAll:[...state.rightAll],
    wrongAll:[...state.wrongAll],
    order:state.order,
    phase:state.phase,
    usingHardestList:state.usingHardestList
  };
  try{localStorage.setItem(k,JSON.stringify(payload))}catch(e){}
}

function loadProgress(){
  const k=keyForSession(state.topic,state.mode,state.runMode,state.exam);
  let raw=null;
  try{raw=localStorage.getItem(k)}catch(e){raw=null}
  if(!raw)return false;

  let data=null;
  try{data=JSON.parse(raw)}catch(e){return false}

  // reconstruir coherencia
  const curr=new Set(state.filtered.map(it=>it.id));
  const saved=new Set((data.filteredIds||[]));
  if(curr.size!==saved.size)return false;
  for(const id of curr){if(!saved.has(id))return false}

  const idToIdx=new Map(state.filtered.map((it,i)=>[it.id,i]));
  const rebuilt=(data.queueIds||[]).map(id=>idToIdx.get(id)).filter(i=>i!==undefined);
  if(!rebuilt.length)return false;

  state.queue=rebuilt;
  state.idx=Math.min(Math.max(0,data.idx||0),state.queue.length-1);
  state.seen=data.seen||0;
  state.correct=data.correct||0;
  state.failedThisRound=new Set(data.failedThisRound||[]);
  state.rightAll=new Set(data.rightAll||[]);
  state.wrongAll=new Set(data.wrongAll||[]);
  state.order=data.order||state.order;
  state.phase='answer';
  state.usingHardestList=!!data.usingHardestList;
  return true;
}

function clearProgress(){
  const k=keyForSession(state.topic,state.mode,state.runMode,state.exam);
  try{localStorage.removeItem(k)}catch(e){}
}

/*** ================== UI HELPERS ================== ***/
function setBanner(id,text,ok){
  const el=document.getElementById(id);
  el.textContent=text;
  el.classList.remove('hidden','ok','ko');
  el.classList.add(ok?'ok':'ko');
}
function clearBanner(id){
  const el=document.getElementById(id);
  el.textContent='';
  el.classList.add('hidden');
  el.classList.remove('ok','ko');
}

function applyFilter(){
  if(state.usingHardestList){
    // state.filtered ya vendr√° preconstruido con solo esas palabras
    return;
  }
  state.filtered = state.items.filter(x =>
    state.topic==='Todos' ? true : (x.topic===state.topic)
  );
}
function buildQueue(){
  const idxs=state.filtered.map((_,i)=>i);
  state.queue=(state.order==='random')?shuffle(idxs):idxs;
  state.idx=0;
}

function currentItem(){
  const i=state.queue[state.idx]??0;
  return state.filtered[i];
}
function percent(){
  if(!state.queue.length)return 0;
  return Math.round(((state.idx)/state.queue.length)*100);
}
function updateProgressUI(){
  document.getElementById('progressBar').style.width=percent()+'%';
  document.getElementById('stats').textContent=
    `Aciertos: ${state.correct} ¬∑ Intentos: ${state.seen} ¬∑ Tema: ${state.topic} ¬∑ ${state.idx+1}/${state.queue.length}`;
}

function renderChips(it){
  const chips=[];
  // mostramos File y Section como chips
  if(it.topic) chips.push(`<span class="chip">${it.topic}</span>`);
  if(it.section) chips.push(`<span class="chip">${it.section}</span>`);
  return chips.join('');
}
function renderExtraInfo(it){
  const lines=[];
  if(it.example) lines.push(`<div><b>Example sentence:</b> ${it.example}</div>`);
  if(it.pron)    lines.push(`<div><b>Pronunciation:</b> ${it.pron}</div>`);
  if(it.pos)     lines.push(`<div><b>Part of speech:</b> ${it.pos}</div>`);
  if(it.en_syn)  lines.push(`<div><b>Synonyms (EN):</b> ${it.en_syn}</div>`);
  if(it.en_mean) lines.push(`<div><b>Additional meanings (EN):</b> ${it.en_mean}</div>`);
  if(it.es_syn)  lines.push(`<div><b>Sin√≥nimos (ES):</b> ${it.es_syn}</div>`);
  if(it.es_mean) lines.push(`<div><b>Acepciones (ES):</b> ${it.es_mean}</div>`);
  return lines.join('') || '<div class="muted">Sin informaci√≥n adicional.</div>';
}

function toggleReviewUI(on){
  document.getElementById('btnNext').classList.toggle('hidden',!on);
  ['btnCheck','btnReveal','btnSkip','btnHard','answer','btnUnhard'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.disabled=on; }
  });
}

function showUnhardButtonIfNeeded(it){
  const btnUnhard=document.getElementById('btnUnhard');
  const k = hardKeyFor(it);
  if(state.hardSet.has(k)){
    btnUnhard.classList.remove('hidden');
  } else {
    btnUnhard.classList.add('hidden');
  }
}

function clearExtraAndFeedback(){
  document.getElementById('extraInfo').innerHTML='';
  document.getElementById('feedback').innerHTML='';
  document.getElementById('chips').innerHTML='';
  toggleReviewUI(false);
  clearBanner('banner');
  document.getElementById('btnUnhard').classList.add('hidden');
}

function updateUI(reset=false){
  const it=currentItem();
  if(!it){
    document.getElementById('prompt').textContent='(Sin datos)';
    return;
  }
  document.getElementById('prompt').textContent=(state.mode==='es_en')?it.spanish:it.english;
  if(reset) document.getElementById('answer').value='';
  document.getElementById('chips').innerHTML = renderChips(it);
  clearExtraAndFeedback();
  updateProgressUI();
  document.getElementById('answer').focus();
}

/*** ================== RESPUESTAS V√ÅLIDAS ================== ***/
function acceptableEnglishSet(it){
  // v√°lido en modo es_en => respuesta en ingl√©s
  const set = new Set([softNorm(it.english)]);
  for(const s of (it.en_syn_list||[])) set.add(softNorm(s));
  return set;
}
function acceptableSpanishSet(it){
  // v√°lido en modo en_es => respuesta en espa√±ol
  const baseSet = new Set();
  // principal + variantes flex
  const baseVariants = FLEX_VARIANTS[it.spanish?.toLowerCase()];
  baseSet.add(norm(it.spanish));
  if(baseVariants){
    for(const v of baseVariants) baseSet.add(norm(v));
  }
  // sin√≥nimos ES
  for(const s of (it.es_syn_list||[])){
    baseSet.add(norm(s));
  }
  return baseSet;
}

/*** ================== NAVEGACI√ìN Y CICLOS ================== ***/
function gotoNext(){
  state.idx++;
  if(state.idx>=state.queue.length){
    handleEndOfCycle();
    return;
  }
  state.phase='answer';
  updateUI(true);
  saveProgress();
}

function handleEndOfCycle(){
  // Reiniciar: vuelve a preguntar solo las falladas
  if(state.runMode==='reiniciar'){
    const failed=[...state.failedThisRound];
    state.failedThisRound.clear();
    if(failed.length>0){
      // quedarnos SOLO con las falladas
      const map=new Map(state.filtered.map((it,idx)=>[it.id,idx]));
      const nextIdxs=failed.map(id=>map.get(id)).filter(i=>i!==undefined);
      state.queue=(state.order==='random')?shuffle(nextIdxs):nextIdxs;
      state.idx=0;
      state.phase='answer';
      updateUI(true);
      saveProgress();
      return;
    }
  }
  showSummary();
  saveProgress();
}

function showSummary(){
  state.phase='summary';
  document.getElementById('btnNext').classList.add('hidden');
  ['btnCheck','btnReveal','btnSkip','btnHard','answer','btnUnhard'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.disabled=true; }
  });

  const sum=document.getElementById('summary');
  const sumCounts=document.getElementById('sumCounts');
  const sumRight=document.getElementById('sumRight');
  const sumWrong=document.getElementById('sumWrong');

  const right=[...state.rightAll];
  const wrong=[...state.wrongAll];
  const map=new Map(state.items.map(it=>[it.id,it]));

  sumCounts.textContent=
    `Aciertos: ${state.correct} ¬∑ Intentos: ${state.seen} ¬∑ Tema: ${state.topic} ¬∑ Palabras: ${state.filtered.length}`;

  function render(ids){
    return ids.map(id=>{
      const it=map.get(id);
      if(!it) return '';
      const shown=(state.mode==='es_en')
        ? `${it.spanish} ‚Üí ${it.english}`
        : `${it.english} ‚Üí ${it.spanish}`;
      return `<div><span class='pill'>${shown}</span></div>`;
    }).join('');
  }
  sumRight.innerHTML=render(right);
  sumWrong.innerHTML=render(wrong);

  // registrar resultado en historial y ense√±ar progreso
  const pct = (state.seen>0)
    ? Math.round((state.correct/state.seen)*100)
    : 0;
  regSessionResult(pct);

  const {prev,now} = lastTwoResults();
  const prevTxt = prev ? `${prev.pct}%` : '--';
  const nowTxt  = now  ? `${now.pct}% ‚úÖ` : '--';
  document.getElementById('progressPrev').textContent = `Sesi√≥n anterior: ${prevTxt}`;
  document.getElementById('progressNow').textContent  = `Hoy: ${nowTxt}`;

  sum.classList.remove('hidden');
}

/*** ================== MOSTRAR SOLUCI√ìN Y CHEQUEO ================== ***/
function showSolutionAndInfo(it, solutionText, note=''){
  const fb=document.getElementById('feedback');
  const ex=document.getElementById('extraInfo');
  const noteHtml=note?` <span class='muted'>(${note})</span>`:'';
  fb.innerHTML='Soluci√≥n: <b>'+solutionText+'</b>'+noteHtml;
  ex.innerHTML=renderExtraInfo(it);
  state.phase='review';
  toggleReviewUI(true);
  showUnhardButtonIfNeeded(it);
  saveProgress();
}

function registerFailForCurrent(it){
  // al fallar, saltar o mostrar soluci√≥n, registramos fallo
  regFail(it);
}

function check(){
  if(state.phase!=='answer') return;
  const it=currentItem();
  if(!it) return;

  let userRaw=String(document.getElementById('answer').value||'');
  userRaw=userRaw.trimEnd();
  const userSoft=softNorm(userRaw); // para ingl√©s
  const userHard=norm(userRaw);     // para espa√±ol (sin acentos)

  let ok=false, solution='', accentsIgnored=false;

  if(state.mode==='es_en'){
    solution = it.english;
    const acc = acceptableEnglishSet(it);
    ok = acc.has(userSoft);
  }else{
    solution = it.spanish;
    const acc = acceptableSpanishSet(it);
    if(acc.has(userHard)){
      ok=true;
      if(!acc.has(userSoft)) accentsIgnored=true;
    }
  }

  state.seen++;
  if(ok){
    state.correct++;
    state.rightAll.add(it.id);
    state.wrongAll.delete(it.id);
    setBanner('banner','Acierto. ¬°Muy bien!',true);
  } else {
    state.failedThisRound.add(it.id);
    state.wrongAll.add(it.id);
    state.rightAll.delete(it.id);
    setBanner('banner','Fallo. ¬°Revisa tu respuesta!',false);
    registerFailForCurrent(it);
  }

  const note=(accentsIgnored && state.mode==='en_es')
    ? 'Se han ignorado los acentos en espa√±ol'
    : '';

  showSolutionAndInfo(it, solution, note);
}

function reveal(){
  if(state.phase!=='answer') return;
  const it=currentItem();
  if(!it) return;

  const sol=(state.mode==='es_en')?it.english:it.spanish;
  setBanner('banner','Mostrada la soluci√≥n de esta tarjeta.',false);

  // mostrar soluci√≥n cuenta como fallo estudiado
  registerFailForCurrent(it);

  showSolutionAndInfo(it,sol);
}

function skip(){
  if(state.phase!=='answer') return;
  const it=currentItem();
  if(!it) return;

  const sol=(state.mode==='es_en')?it.english:it.spanish;
  setBanner('banner','Mostrada la soluci√≥n de esta tarjeta.',false);

  // saltar = tambi√©n contabiliza como fallo
  registerFailForCurrent(it);

  showSolutionAndInfo(it,sol);
}

/*** ================== DIF√çCILES (toggle y quitar) ================== ***/
function toggleHard(){
  if(state.phase!=='answer') return;
  const it=currentItem();
  if(!it) return;

  const k = hardKeyFor(it);
  if(state.hardSet.has(k)){
    // ya era dif√≠cil -> quitar
    state.hardSet.delete(k);
    saveHardSet(state.hardSet);
    setBanner('banner','Quitada de dif√≠ciles.',false);
  } else {
    state.hardSet.add(k);
    saveHardSet(state.hardSet);
    setBanner('banner','Marcada como dif√≠cil.',false);
  }

  const sol=(state.mode==='es_en')?it.english:it.spanish;
  showSolutionAndInfo(it,sol);
}

// Bot√≥n espec√≠fico "Ya no es dif√≠cil"
function unhardNow(){
  // disponible en fase review, visible s√≥lo si estaba marcada
  const it=currentItem();
  if(!it) return;
  const k=hardKeyFor(it);
  if(state.hardSet.has(k)){
    state.hardSet.delete(k);
    saveHardSet(state.hardSet);
    setBanner('banner','Quitada de dif√≠ciles.',false);
    // volver a mostrar info (sigue en review)
    const sol=(state.mode==='es_en')?it.english:it.spanish;
    showSolutionAndInfo(it,sol);
  }
}

/*** ================== EVENTOS PRINCIPALES ================== ***/
document.getElementById('btnCheck').addEventListener('click',check);
document.getElementById('btnReveal').addEventListener('click',reveal);
document.getElementById('btnSkip').addEventListener('click',skip);
document.getElementById('btnHard').addEventListener('click',toggleHard);
document.getElementById('btnUnhard').addEventListener('click',unhardNow);
document.getElementById('btnNext').addEventListener('click',gotoNext);
document.getElementById('sumRestart').addEventListener('click',()=>{ goWelcome(true) });

document.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    if(viewIsQuiz() && state.phase==='answer') check();
    else if(viewIsQuiz() && state.phase==='review') gotoNext();
  }
});

document.getElementById('btnReset').addEventListener('click',()=>goWelcome(false));

/*** ================== VISTAS: WELCOME / HARDEST / QUIZ ================== ***/
function viewIsQuiz(){
  return !document.getElementById('quizView').classList.contains('hidden');
}
function showView(idToShow){
  // welcomeView, hardestView, quizView
  ['welcomeView','hardestView','quizView'].forEach(id=>{
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(idToShow).classList.remove('hidden');
}

function fillLastResultBox(){
  const box=document.getElementById('lastResultBox');
  const last=lastResult();
  if(!last){
    box.textContent='√öltimo resultado: --';
  } else {
    box.textContent=`√öltimo resultado: ${last.pct}% de aciertos üëå`;
  }
}

function buildHardestList(){
  const listBox=document.getElementById('hardListBox');
  const top=topFailList(10); // [ [ "english|spanish", count ], ... ]
  if(top.length===0){
    listBox.innerHTML='<div class="muted">A√∫n no hay datos de fallos suficientes.</div>';
    return;
  }
  // Para mostrar bonito necesitamos mapear cada clave a sus textos reales
  // Buscamos en DATA la primera coincidencia english|spanish
  const lines=[];
  for(const [k,count] of top){
    const [en,es]=k.split('|');
    lines.push(`<div><b>${en}</b> ‚Üí ${es} (${count} fallos)</div>`);
  }
  listBox.innerHTML = lines.join('');
}

/*** construir lista filtrada "solo estas ahora" para practicar las enemigas */
function startPracticeHardest(){
  const top=topFailList(10); // keys + counts
  // generamos lista de items a partir de DATA
  const wantedKeys = new Set(top.map(([k])=>k.toLowerCase()));
  const subset = state.items.filter(it=> wantedKeys.has(hardKeyFor(it)));
  if(subset.length===0){
    // si no hay subset real, volvemos y no hacemos nada raro
    setBanner('bannerWelcome','No hay suficientes palabras con fallos.',false);
    showView('welcomeView');
    return;
  }

  state.usingHardestList = true;
  state.filtered = subset.slice();
  state.topic = 'Enemigas';
  state.order = 'random';

  state.queue = shuffle(state.filtered.map((_,i)=>i));
  state.idx=0;
  state.seen=0;
  state.correct=0;
  state.failedThisRound.clear();
  state.rightAll.clear();
  state.wrongAll.clear();

  // pasamos directamente al quizView
  showView('quizView');
  document.getElementById('btnReveal').classList.toggle('hidden', state.exam);
  document.getElementById('btnSkip').classList.toggle('hidden', state.exam);
  document.getElementById('btnHard').classList.toggle('hidden', state.exam);
  state.phase='answer';
  updateUI(true);
  saveProgress();
}

/*** welcome: volver y arrancar ***/
document.getElementById('btnHardest').addEventListener('click',()=>{
  buildHardestList();
  showView('hardestView');
});
document.getElementById('btnBackToWelcome').addEventListener('click',()=>{
  showView('welcomeView');
});

document.getElementById('btnPracticeHardest').addEventListener('click',()=>{
  // practicamos SOLO las m√°s dif√≠ciles
  state.exam = false; // modo m√°s natural: sin examen estricto aqu√≠
  startPracticeHardest();
});

function goWelcome(hardReset){
  if(hardReset){
    clearProgress();
  }

  state.usingHardestList = false;

  configureTopics('w_topic');
  const hasSaved=Object.keys(localStorage).some(k=>k.startsWith('vocab2c1::'));
  document.getElementById('resumeBox').classList.toggle('hidden', !hasSaved);

  clearBanner('banner');
  clearBanner('bannerWelcome');

  fillLastResultBox();

  showView('welcomeView');
}

function startFromWelcome(resume){
  state.mode=document.getElementById('w_mode').value;
  state.order=document.getElementById('w_order').value;
  state.topic=document.getElementById('w_topic').value||'Todos';
  state.runMode=document.getElementById('w_runMode').value;
  state.exam=document.getElementById('w_exam').checked;

  state.usingHardestList = false;

  applyFilter();
  buildQueue();

  let loaded=false;
  if(resume){
    loaded=loadProgress();
  }
  if(!loaded){
    state.idx=0;
    state.seen=0;
    state.correct=0;
    state.failedThisRound.clear();
    state.rightAll.clear();
    state.wrongAll.clear();
  }

  showView('quizView');

  document.getElementById('btnReveal').classList.toggle('hidden', state.exam);
  document.getElementById('btnSkip').classList.toggle('hidden', state.exam);
  document.getElementById('btnHard').classList.toggle('hidden', state.exam);

  state.phase='answer';
  updateUI(true);
  saveProgress();
}

/*** temas en selector ***/
function configureTopics(selId){
  TOPICS = ['Todos', ...Array.from(new Set(
    (DATA||[]).map(x => x.topic || '').filter(x => x && x.trim()!=='')
  ))];
  const sel=document.getElementById(selId);
  sel.innerHTML = TOPICS.map(t =>
    `<option value="${t}">${t}</option>`
  ).join('');
}

/*** INICIO APP ***/
(async function init(){
  try{
    await loadExcelToDATA();
  }catch(err){
    console.error(err);
    setBanner('bannerWelcome','No se pudo cargar el Excel. Aseg√∫rate de subirlo junto a index.html con el nombre exacto.', false);
  }

  // estado inicial
  state.items = (DATA || []).slice();
  state.hardSet = loadHardSet(); // cargamos dif√≠ciles guardadas

  configureTopics('w_topic');
  fillLastResultBox();

  document.getElementById('btnStart').addEventListener('click', ()=>startFromWelcome(false));
  document.getElementById('btnResume').addEventListener('click', ()=>startFromWelcome(true));

  // autoconfig inicial seg√∫n √∫ltima sesi√≥n guardada (heur√≠stica)
  let lastKey=null;
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k && k.startsWith('vocab2c1::') && k!==FAIL_KEY && k!==HIST_KEY && k!==HARD_KEY){
      lastKey=k; break;
    }
  }
  if(lastKey){
    const parts=lastKey.split('::'); // vocab2c1::topic::mode::runMode::exam/normal
    if(parts.length>=5){
      const [_p,topic,mode,run,examTag]=parts;
      if(TOPICS.includes(topic)) document.getElementById('w_topic').value=topic;
      if(['es_en','en_es'].includes(mode)) document.getElementById('w_mode').value=mode;
      if(['reiniciar','completar'].includes(run)) document.getElementById('w_runMode').value=run;
      document.getElementById('w_exam').checked = (examTag==='exam');
      document.getElementById('resumeBox').classList.remove('hidden');
    }
  }

  goWelcome(false);
})();
</script>
</body>
</html>
